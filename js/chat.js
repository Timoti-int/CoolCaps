// ƒåekamo da se DOM uƒçita
window.onload = function() {
    // Uzimamo sve potrebne elemente
    const header = document.querySelector('.chat-header');
    const body = document.querySelector('.chat-body');
    const input = document.querySelector('.chat-input input');
    const sendBtn = document.querySelector('.send-btn');
    const messagesContainer = document.querySelector('.chat-messages');
    
    // Inicijalno sakrivamo chat body
    body.style.display = 'none';
    
    // Funkcija za toggle chat-a
    header.onclick = function() {
        if (body.style.display === 'none') {
            // Otvaramo chat
            body.style.display = 'block';
            body.style.opacity = '0';
            setTimeout(() => {
                body.style.opacity = '1';
                input.focus(); // Fokusiramo input polje
            }, 50);
        } else {
            // Zatvaramo chat
            body.style.opacity = '0';
            setTimeout(() => {
                body.style.display = 'none';
            }, 300);
        }
    };
    
    // Funkcija za dodavanje poruke u chat
    function addMessage(text, isUser = false) {
        const message = document.createElement('div');
        message.classList.add('message');
        message.classList.add(isUser ? 'user-message' : 'bot-message');
        message.textContent = text;
        
        // Dodajemo poruku sa fade-in efektom
        message.style.opacity = '0';
        messagesContainer.appendChild(message);
        setTimeout(() => {
            message.style.opacity = '1';
        }, 50);
        
        // Skrolujemo na dno
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Funkcija za slanje poruke
    function sendMessage() {
        const text = input.value.trim();
        if (text) {
            // Dodajemo korisniƒçku poruku
            addMessage(text, true);
            
            // ƒåistimo input
            input.value = '';
            
            // Dobijamo odgovor od bota
            const response = findResponse(text);
            
            // Simuliramo kucanje (3 taƒçkice)
            setTimeout(() => {
                addMessage('...', false);
                
                // Nakon 1 sekunde zamenjujemo taƒçkice pravim odgovorom
                setTimeout(() => {
                    messagesContainer.removeChild(messagesContainer.lastChild);
                    addMessage(response, false);
                }, 1000);
            }, 500);
        }
    }
    
    // Event listener za slanje poruke
    sendBtn.onclick = sendMessage;
    
    // Event listener za Enter taster
    input.onkeypress = function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    };
};

// Defini≈°emo mapu kljuƒçnih reƒçi za prepoznavanje pitanja
const keywordMap = {
    // Osnovne informacije
    "sta_je": ["sta je", "≈°ta je", "sta su", "≈°ta su", "papermints", "coolcaps", "objasni", "proizvod", "kako radi", "reci mi vi≈°e"],
    
    // Prodajna mesta (pro≈°irena lista)
    "kupovina": [
        "gde kupiti", 
        "gde da kupim", 
        "gde ima da se kupi",
        "gde mo≈æe da se kupi",
        "gde mogu da kupim",
        "prodaja", 
        "prodavnica", 
        "apoteka", 
        "mesto", 
        "nabaviti", 
        "prodajno", 
        "kupim", 
        "nadjem", 
        "naƒëem",
        "prodajna mesta",
        "lokacije",
        "gde prodajete",
        "gde se prodaje"
    ],
    
    // Cena (pro≈°irena lista)
    "cena": [
        "cena", 
        "ko≈°ta", 
        "kosta", 
        "cene", 
        "ko≈°tanje", 
        "kostanje", 
        "dinara", 
        "rsd",
        "koliko para",
        "koja je cena",
        "cena proizvoda",
        "koliko je",
        "koliko ko≈°ta",
        "koliko kosta"
    ],
    
    // Ukusi
    "ukusi": ["ukus", "ukusi", "mentol", "jagoda", "aroma", "koji ukus", "dostupni ukusi", "uku≈°i"],
    
    // Upotreba
    "upotreba": ["kako koristiti", "upotreba", "naƒçin", "nacin", "kako se uzima", "kako jesti", "uputstvo"],
    
    // Pakovanja
    "pakovanja": ["pakovanje", "pakovanja", "tuba", "box40", "kutijica", "veliƒçine", "velicine"],
    
    // Sastav i bezbednost
    "sastav": ["sastav", "sastojci", "prirodno", "≈°eƒáer", "secer", "kalorije", "alergije"],
    
    // Isporuka
    "isporuka": ["isporuka", "dostava", "slanje", "shipping", "isporuƒçuje", "isporucuje"],
    
    // Kontakt
    "kontakt": ["kontakt", "email", "telefon", "kontaktiraj"],
    
    // Zabavna pitanja
    "zabava": ["kako se zove≈°", "koliko ima≈° godina", "voli≈°", "spava≈°", "vic", "≈°ta radi≈°"],
    
    // Doziranje
    "doziranje": [
        "koliko sme", 
        "koliko mo≈æe", 
        "koliko dnevno", 
        "dnevna doza", 
        "koliko da popijem",
        "koliko da pojedem",
        "koliko da uzmem",
        "koliko kapsula",
        "maksimalna doza",
        "preporuƒçena doza",
        "preporucena doza",
        "koliko puta dnevno",
        "koliko ƒçesto",
        "koliko cesto"
    ],
};

// Defini≈°emo odgovore
const responses = {
    // Osnovne informacije o proizvodu
    "sta_je": "PaperMints CoolCaps su dvostruke kapsule koje pru≈æaju instant osve≈æenje daha i dugotrajnu sve≈æinu iz stomaka.",
    "kupovina": "PaperMints CoolCaps mo≈æete kupiti na sledeƒáim mestima:\n\n" +
               "üè™ Apoteke:\n" +
               "- Galen\n" +
               "- Lipa Lek\n" +
               "- Zdravkoviƒá\n" +
               "- Super Dr. Max\n" +
               "- Vista\n" +
               "- Vipera\n\n" +
               "‚õΩ Benzinske stanice:\n" +
               "- OMV\n\n" +
               "üè• Zdravstvene ustanove:\n" +
               "- International Health",
    "cena": "üí∞ Cene PaperMints CoolCaps:\n\n" +
            "‚Ä¢ Tuba (18 kapsula): 370 RSD\n" +
            "‚Ä¢ Box40 (40 kapsula): 690 RSD\n\n" +
            "üì¶ Napomena za online kupovinu:\n" +
            "Minimum za online porud≈æbinu je 3 komada.",
    "ukusi": "Dostupni su ukusi mentola i jagode. Ukus jagode je dostupan samo u tubi, dok je ukus mentola dostupan u oba pakovanja.",
    "upotreba": "Stavite kapsulu na jezik. Spoljni sloj se rastapa u ustima, dok ostatak progutate za dugotrajnu sve≈æinu.",
    "pakovanja": "PaperMints CoolCaps su dostupni u tubi sa 18 kapsula i kutijici Box40 sa 40 kapsula.",
    "sastav": "Ne, proizvod sadr≈æi aspartam i sukralozu, ali su svi sastojci pa≈æljivo birani i nisu ≈°tetni.",
    "isporuka": "Isporuka se vr≈°i Daily express-om u roku od 2-3 radna dana.",
    "kontakt": "Mo≈æete nas kontaktirati putem sekcije za kontakte.",
    "zabava": "Ja sam PaperMints chatbot, uvek sve≈æ i spreman da pomognem!",
    "doziranje": "PaperMints CoolCaps kapsule se koriste po potrebi - kada ≈æelite osve≈æenje daha. üòä\n\n" +
                "Idealno je uzeti kapsulu:\n" +
                "‚Ä¢ Nakon obroka\n" +
                "‚Ä¢ Posle kafe\n" +
                "‚Ä¢ Nakon cigareta\n" +
                "‚Ä¢ Ili kad god po≈æelite sve≈æ dah",
    "default": "Izvinjavam se, nisam siguran kako da odgovorim na to pitanje. Mo≈æete pitati o cenama, ukusima, gde kupiti, naƒçinu upotrebe ili sastavu proizvoda."
};

// Funkcija za normalizaciju teksta
function normalizeText(text) {
    return text.toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[.,?!]/g, '');
}

// Funkcija za prepoznavanje pitanja i davanje odgovora
function findResponse(message) {
    const normalizedInput = normalizeText(message);
    
    // Dodajemo console.log za debugging
    console.log("Normalized input:", normalizedInput);
    
    for (let question in responses) {
        const normalizedQuestion = normalizeText(question);
        console.log("Checking question:", normalizedQuestion);
        
        if (normalizedInput.includes(normalizedQuestion) || normalizedQuestion.includes(normalizedInput)) {
            console.log("Match found! Response:", responses[question]);
            return responses[question];
        }
    }
    
    return responses["default"];
}

// Dodaj na poƒçetak fajla, odmah nakon const responses = {...}
function toggleAssistant() {
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.style.display = chatContainer.style.display === 'none' ? 'block' : 'none';
}

// Izmeni event listener sekciju na kraju fajla
document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('toggleAssistant');
    const chatContainer = document.getElementById('chatContainer');
    const userInput = document.getElementById('userInput');
    const chatMessages = document.getElementById('chatMessages');
    const sendButton = document.getElementById('sendMessage');

    // Toggle chat
    if (toggleButton && chatContainer) {
        toggleButton.addEventListener('click', function() {
            const isHidden = chatContainer.style.display === 'none';
            chatContainer.style.display = isHidden ? 'block' : 'none';
            toggleButton.classList.toggle('active');
        });
    }

    // Funkcija za dodavanje poruke
    function addMessage(message, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = isUser ? 'message user-message' : 'message bot-message';
        messageDiv.textContent = message;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Funkcija za prepoznavanje pitanja
    function identifyQuestion(input) {
        const lowercaseInput = input.toLowerCase();
        
        for (let category in keywordMap) {
            for (let keyword of keywordMap[category]) {
                if (lowercaseInput.includes(keyword)) {
                    return category;
                }
            }
        }
        return "default";
    }

    // Funkcija za dobijanje odgovora
    function getResponse(input) {
        const questionType = identifyQuestion(input);
        return responses[questionType] || responses["default"];
    }

    // Event listener za slanje poruke
    if (sendButton && userInput) {
        sendButton.addEventListener('click', function() {
            const message = userInput.value.trim();
            if (message) {
                addMessage(message, true);
                const response = getResponse(message);
                setTimeout(() => addMessage(response), 500);
                userInput.value = '';
            }
        });

        // Enter taster
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });
    }
});

const qaPairs = [
    // ... postojeƒáa pitanja i odgovori ...
    {
        question: ["koliko ima kapsula u tubi", "koliko kapsula sadr≈æi tuba", "broj kapsula u tubi"],
        answer: "Tuba sadr≈æi 18 kapsula."
    },
    {
        question: ["koliko ima u tubi", "koliko u tubi", "tuba koliƒçina"],
        answer: "Tuba sadr≈æi 18 kapsula."
    },
    {
        question: ["da li ima veƒáe pakovanje", "ima li veƒáe pakovanje", "veƒáe pakovanje", "veƒáa kutija"],
        answer: "Da, ima veƒáe pakovanje BOX40 sa 40 kapsula u kutijici."
    },
    {
        question: ["isporuka", "dostava", "kako se dostavlja", "kada stize", "kada ƒáe stiƒái"],
        answer: "Isporuka se vr≈°i preko kurirske slu≈æbe Daily Express, po≈°iljka sti≈æe za jedan radni dan ako kuriri ne kasne sa isporukom."
    },
    {
        question: ["kojom kurirskom slu≈æbom ≈°aljete", "kako ≈°aljete", "koja kurirska slu≈æba", "koji kurir", "koji dostavljaƒç"],
        answer: "Isporuka se vr≈°i preko kurirske slu≈æbe Daily Express, po≈°iljka sti≈æe za jedan radni dan ako kuriri ne kasne sa isporukom."
    },
    // ... ostala pitanja i odgovori ...
]; 